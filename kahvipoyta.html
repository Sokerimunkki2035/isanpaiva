<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Kahvipöytä – Ääniystävä</title>
<style>
  body{background:#fafafa;font-family:system-ui,Arial;margin:0}
  header{position:sticky;top:0;background:#fff;padding:14px 16px;
    box-shadow:0 1px 6px rgba(0,0,0,.06)}
  h1{font-size:20px;margin:0}
  main{padding:16px}
  .chat{background:#fff;border:1px solid #eee;border-radius:14px;
    padding:12px;max-height:60vh;overflow:auto}
  .msg{margin:10px 0}
  .me{color:#111}
  .hanhi{color:#0d6efd}
  .pappa{color:#16a34a}
  .row{display:flex;gap:8px;margin-top:10px}
  .row button{flex:1;padding:10px;border-radius:10px;border:1px solid #ddd;background:#fff}
  .input{display:flex;gap:8px;margin-top:10px}
  .input input{flex:1;padding:12px;border:1px solid #ddd;border-radius:10px}
  .input button{padding:12px 14px;border:1px solid #ddd;border-radius:10px;background:#fff}
  .small{font-size:12px;color:#666;margin-top:6px}
</style>
</head>
<body>
<header><h1>☕ Kahvipöytä – Ääniystävä</h1></header>
<main>
  <div id="chat" class="chat" aria-live="polite"></div>

  <div class="row">
    <button onclick="preset('minulla ei ole ketään')">minulla ei ole ketään</button>
    <button onclick="preset('oli hyvä päivä töissä')">oli hyvä päivä töissä</button>
    <button onclick="preset('saanko kysyä jotain')">saanko kysyä jotain</button>
  </div>

  <div class="input">
    <input id="text" placeholder="Kirjoita tähän ja paina Lähetä…">
    <button onclick="send()">Lähetä</button>
    <button onclick="stopSpeak()">⏹</button>
  </div>
  <div class="small">Vinkki: Ääni toistuu vain käyttäjän klikkauksen jälkeen (selaimen sääntö).</div>
</main>

<script>
/* --- perus TTS --- */
const synth = window.speechSynthesis;
function say(text, lang = "fi-FI"){
  try{synth.cancel();}catch(e){}
  const u = new SpeechSynthesisUtterance(text);
  u.lang = lang;
  synth.speak(u);
}
function stopSpeak(){ try{synth.cancel();}catch(e){} }

/* --- UI helperit --- */
const chat = document.getElementById('chat');
function addLine(cls, who, text){
  const div = document.createElement('div');
  div.className = 'msg ' + cls;
  div.textContent = who + ': ' + text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

/* --- hyvin kevyt moderointi (estetään rasismi/viha) --- */
const banned = [/rasis/i,/neger/i,/fag/i,/hitler/i,/natsi/i,/homo\s+viha/i,/go back/i];
function isBad(t){ return banned.some(rx => rx.test(t)); }

/* --- persona-ydin (turvallinen) --- */
function hanhiReply(user){
  // 3–5 lausetta, lempeä + “honk”
  const starts = [
    "Olen tässä vierelläsi, kuulolla.",
    "Kuulen sinut ja haluan, että tunnet olosi turvalliseksi.",
    "Ymmärrän että tämä hetki voi painaa."
  ];
  const middles = [
    "Olen kulkenut monien maiden yli ja oppinut, että lempeys kantaa.",
    "Voimme hengittää rauhassa, yhden pienen hengityksen kerrallaan.",
    "Et ole yksin, vaikka siltä saattaa tuntua."
  ];
  const ends = [
    "Haluatko kertoa lisää, honk?",
    "Otan siivilläni pienen varjon pois päivästäsi, honk.",
    "Jatketaan yhdessä vielä hetki, honk."
  ];
  return pick(starts)+" "+pick(middles)+" "+pick(ends);
}

function pappaReply(user){
  // 2–3 lausetta + kysymys, “ihaa”
  const starts = [
    "Istun tähän viereen, kaadan kuppiin vielä tilkan.",
    "Katsos, joskus ilokin on hiljaista, ihaa.",
    "Matkoilla opin: askel kerrallaan riittää."
  ];
  const questions = [
    "Mikä olisi sinulle pieni hyvä juttu tänään?",
    "Mihin suuntaan sydän kallistuisi seuraavaksi?",
    "Kenen nimeä ajattelit mielessäsi äsken?"
  ];
  return pick(starts)+" "+pick(questions);
}

function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

/* --- ohjaus --- */
function preset(text){ document.getElementById('text').value = text; send(); }

async function send(){
  const inp = document.getElementById('text');
  const user = (inp.value || "").trim();
  if(!user) return;

  addLine('me','Sinä', user);

  // kevyt moderointi
  if(isBad(user)){
    const safe = "Pidetään keskustelu turvallisena ja kunnioittavana. Voimme puhua yksinäisyydestä, toivosta tai tästä hetkestä.";
    addLine('hanhi','Äiti-Hanhi', safe + " honk.");
    say(safe+" honk.");
    const follow = "Mille tuntuisi, jos aloittaisimme ihan pienellä hengityksellä yhdessä, ihaa?";
    setTimeout(()=>{
      addLine('pappa','Aasi-pappa', follow);
      say(follow);
    }, 1200);
    inp.value = ""; return;
  }

  // Hanhi vastaa ensin (pidempi)
  const h = hanhiReply(user);
  setTimeout(()=>{ addLine('hanhi','Äiti-Hanhi', h); say(h); }, 150);

  // Pappa kommentoi perään (lyhyempi + kysymys)
  const p = pappaReply(user);
  setTimeout(()=>{ addLine('pappa','Aasi-pappa', p); say(p); }, 1400);

  inp.value = "";
}
</script>
</body>
</html>